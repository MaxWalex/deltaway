{"remainingRequest":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/babel-loader/lib/index.js??ref--5-2!/Users/dimasabitov/Downloads/deltaway.20/server/api/admin/transaction/services/deleteByIds.js","dependencies":[{"path":"/Users/dimasabitov/Downloads/deltaway.20/server/api/admin/transaction/services/deleteByIds.js","mtime":1671546369635},{"path":"/Users/dimasabitov/Downloads/deltaway.20/.babelrc","mtime":1671546158632},{"path":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/cache-loader/dist/cjs.js","mtime":1671546959174},{"path":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/babel-loader/lib/index.js","mtime":1671546957682}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.default = deleteByIds;\n\nvar _constants = require('../../../../constants/constants');\n\nvar _getStatus = require('../../../../helpers/getStatus');\n\nvar _getStatus2 = _interopRequireDefault(_getStatus);\n\nvar _deleteByIds = require('../../../client/transaction/queries/deleteByIds');\n\nvar _deleteByIds2 = _interopRequireDefault(_deleteByIds);\n\nvar _getTransactionsByIds = require('../../../client/transaction/queries/getTransactionsByIds');\n\nvar _getTransactionsByIds2 = _interopRequireDefault(_getTransactionsByIds);\n\nvar _getAllTransactions = require('../../../client/transaction/queries/getAllTransactions');\n\nvar _getAllTransactions2 = _interopRequireDefault(_getAllTransactions);\n\nvar _editUser = require('../../../client/user/queries/editUser');\n\nvar _editUser2 = _interopRequireDefault(_editUser);\n\nvar _getAllUsers = require('../../../client/user/queries/getAllUsers');\n\nvar _getAllUsers2 = _interopRequireDefault(_getAllUsers);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction deleteByIds(req, res) {\n    var _req$body = req.body,\n        ids = _req$body.ids,\n        user = _req$body.user;\n\n\n    (0, _getTransactionsByIds2.default)(ids).then(function (transactions) {\n        var transactionsByType = {};\n        var _iteratorNormalCompletion = true;\n        var _didIteratorError = false;\n        var _iteratorError = undefined;\n\n        try {\n            for (var _iterator = transactions[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                var transaction = _step.value;\n\n                !transactionsByType[transaction.type] ? transactionsByType[transaction.type] = transaction.value : transactionsByType[transaction.type] += transaction.value;\n            }\n        } catch (err) {\n            _didIteratorError = true;\n            _iteratorError = err;\n        } finally {\n            try {\n                if (!_iteratorNormalCompletion && _iterator.return) {\n                    _iterator.return();\n                }\n            } finally {\n                if (_didIteratorError) {\n                    throw _iteratorError;\n                }\n            }\n        }\n\n        if (user.balance > 0 && transactionsByType.deposit && transactionsByType.deposit > 0) {\n            user.balance -= transactionsByType.deposit;\n        }\n        if (user.mainBalance > 0 && transactionsByType.deposit && transactionsByType.deposit > 0) {\n            user.mainBalance -= transactionsByType.deposit;\n        }\n        if (user.bonuses > 0 && transactionsByType.bonuses && transactionsByType.bonuses > 0) {\n            user.bonuses -= transactionsByType.bonuses;\n        }\n        if (user.credFacilities > 0 && transactionsByType.credFacilities && transactionsByType.credFacilities > 0) {\n            user.credFacilities -= transactionsByType.credFacilities;\n        }\n\n        if (user.balance < 0 || user.mainBalance < 0 || user.bonuses < 0 || user.credFacilities < 0) {\n            return res.status(_constants.BAD_REQUEST_STATUS_CODE).send({ error: 'Значение не может быть отрицательным' });\n        }\n\n        user.accountStatus = (0, _getStatus2.default)(user.balance, user.isVipStatus);\n\n        (0, _deleteByIds2.default)(ids).then(function () {\n            console.log('save', {\n                id: user.id,\n                balance: user.balance,\n                mainBalance: user.mainBalance,\n                accountStatus: user.accountStatus,\n                bonuses: user.bonuses,\n                credFacilities: user.credFacilities\n            });\n            (0, _editUser2.default)({\n                id: user.id,\n                balance: user.balance,\n                mainBalance: user.mainBalance,\n                accountStatus: user.accountStatus,\n                bonuses: user.bonuses,\n                credFacilities: user.credFacilities\n            }).then(function () {\n                (0, _getAllUsers2.default)().then(function (users) {\n                    (0, _getAllTransactions2.default)().then(function (transactions) {\n                        res.status(_constants.OKEY_STATUS_CODE).send({ transactions: transactions, users: users });\n                    });\n                }).catch(function () {\n                    res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n                });\n            });\n        }).catch(function () {\n            res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n        });\n    }).catch(function () {\n        res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n    });\n}\ndeleteByIds.i = 'deleteByIds';\ndeleteByIds.i = 'deleteByIds';",null]}