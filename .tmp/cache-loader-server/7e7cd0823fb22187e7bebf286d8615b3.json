{"remainingRequest":"/home/vps/ppf/node_modules/babel-loader/lib/index.js??ref--5-2!/home/vps/ppf/server/controllers/pricesController.js","dependencies":[{"path":"/home/vps/ppf/server/controllers/pricesController.js","mtime":1671127398084},{"path":"/home/vps/ppf/.babelrc","mtime":1671127885972},{"path":"/home/vps/ppf/node_modules/cache-loader/dist/cjs.js","mtime":1671127657171},{"path":"/home/vps/ppf/node_modules/babel-loader/lib/index.js","mtime":1671127654997}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.pricesEvents = undefined;\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _defineProperty2 = require('babel-runtime/helpers/defineProperty');\n\nvar _defineProperty3 = _interopRequireDefault(_defineProperty2);\n\nvar _extends5 = require('babel-runtime/helpers/extends');\n\nvar _extends6 = _interopRequireDefault(_extends5);\n\nvar _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');\n\nvar _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);\n\nvar _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require('babel-runtime/helpers/createClass');\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _constants = require('../constants/constants');\n\nvar _ws = require('ws');\n\nvar _ws2 = _interopRequireDefault(_ws);\n\nvar _eventemitter = require('eventemitter3');\n\nvar _eventemitter2 = _interopRequireDefault(_eventemitter);\n\nvar _lodash = require('lodash.remove');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _fs = require('fs');\n\nvar _fs2 = _interopRequireDefault(_fs);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _bluebird = require('bluebird');\n\nvar _bluebird2 = _interopRequireDefault(_bluebird);\n\nvar _last = require('@tinkoff/utils/array/last');\n\nvar _last2 = _interopRequireDefault(_last);\n\nvar _undefined = require('@tinkoff/utils/is/undefined');\n\nvar _undefined2 = _interopRequireDefault(_undefined);\n\nvar _nodeSchedule = require('node-schedule');\n\nvar _nodeSchedule2 = _interopRequireDefault(_nodeSchedule);\n\nvar _symbols = require('../constants/symbols');\n\nvar _getPeriodByTimeframe = require('../../src/apps/client/ui/pages/MainPage/utils/getPeriodByTimeframe');\n\nvar _getPeriodByTimeframe2 = _interopRequireDefault(_getPeriodByTimeframe);\n\nvar _getHistoryPrice = require('../../src/apps/client/services/client/getHistoryPrice');\n\nvar _getHistoryPrice2 = _interopRequireDefault(_getHistoryPrice);\n\nvar _getAssetValues = require('../../src/apps/client/utils/getAssetValues');\n\nvar _base = require('../../src/apps/admin/services/base');\n\nvar _base2 = _interopRequireDefault(_base);\n\nvar _superagent = require('superagent');\n\nvar _superagent2 = _interopRequireDefault(_superagent);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar pricesEvents = exports.pricesEvents = new _eventemitter2.default();\n\nvar key = _fs2.default.readFileSync(_path2.default.resolve('./server/https/private.key'), 'utf8');\nvar cert = _fs2.default.readFileSync(_path2.default.resolve('./server/https/certificate.crt'), 'utf8');\n\nvar PricesController = function () {\n    function PricesController() {\n        var _this = this;\n\n        (0, _classCallCheck3.default)(this, PricesController);\n        this.prices = {};\n        this.prevPrices = {};\n\n        this.restartConnection = function () {\n            // this.socket && this.socket.close();\n        };\n\n        this.orders = [];\n\n        this.prefix = process.env.NODE_ENV === 'production' ? 'https://' + _constants.DOMAIN : 'http://localhost:4000';\n\n        this.getOredrs().then(function (orders) {\n            // console.log('constructor -> getOredrs');\n            _this.orders = orders;\n\n            _this.checkBeforeCloseOrder();\n        }).catch(function (e) {\n            return e;\n        });\n\n        setInterval(function () {\n            _this.getOredrs().then(function (orders) {\n                _this.orders = orders;\n            }).catch(function (e) {\n                return e;\n            });\n        }, 10 * 1000);\n    }\n\n    (0, _createClass3.default)(PricesController, [{\n        key: 'start',\n        value: function start() {\n            var _this2 = this;\n\n            // if (process.env.NODE_ENV === 'production') {\n            this.getInitPrices();\n            // }\n\n            var setWebsocket = function setWebsocket() {\n                try {\n                    var socket = new _ws2.default('wss://ws.finnhub.io?token=' + _constants.FINNHUB_API_KEY);\n\n                    socket.addEventListener('open', function () {\n                        _symbols.CURRENCIES_SYMBOLS.forEach(function (_ref) {\n                            var name = _ref.name;\n\n                            socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': name }));\n                        });\n                        _symbols.VALUES_SYMBOLS.forEach(function (_ref2) {\n                            var name = _ref2.name;\n\n                            socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': name }));\n                        });\n                        _symbols.COMPANY_SHARES_SYMBOLS.forEach(function (_ref3) {\n                            var name = _ref3.name;\n\n                            socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': name }));\n                        });\n                        _symbols.INDICES_SYMBOLS.forEach(function (_ref4) {\n                            var name = _ref4.name;\n\n                            socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': name }));\n                        });\n                        _symbols.CRYPTO_CURRENCIES_SYMBOLS.forEach(function (_ref5) {\n                            var name = _ref5.name;\n\n                            socket.send(JSON.stringify({ 'type': 'subscribe', 'symbol': name }));\n                        });\n                    });\n\n                    socket.addEventListener('message', function (event) {\n                        var data = JSON.parse(event.data);\n\n                        if (!data.data) {\n                            return;\n                        }\n                        var newPrice = data.data[0].p;\n                        var symbolName = data.data[0].s;\n                        var symbolTime = data.data[0].t;\n\n                        if (newPrice === _this2.prices[symbolName]) {\n                            return;\n                        }\n\n                        var assetPriceChange = {\n                            name: symbolName,\n                            price: newPrice,\n                            time: symbolTime,\n                            changes: newPrice > _this2.prices[symbolName] ? 'up' : 'down'\n                        };\n                        _this2.prevPrices[symbolName] = _this2.prices[symbolName];\n                        _this2.prices[symbolName] = newPrice;\n\n                        assetPriceChange.prevPrice = _this2.prevPrices[symbolName];\n\n                        pricesEvents.emit(_constants.SYMBOL_PRICE_CHANGE_EVENT, { prices: _this2.prices, assetPriceChange: assetPriceChange });\n                    });\n\n                    // socket.addEventListener('error', (data) => console.log(data));\n                    socket.addEventListener('error', function (data) {\n                        return data;\n                    });\n\n                    socket.addEventListener('close', function (data) {\n                        // console.log('socket close', data);\n                        setTimeout(function () {\n                            setWebsocket();\n                        }, 1000);\n                    });\n\n                    _this2.socket = socket;\n                } catch (e) {}\n            };\n\n            setWebsocket();\n\n            _nodeSchedule2.default.scheduleJob({ hour: 6 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 8 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 10 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 12 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 14 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 16 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 18 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 18 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 20 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ hour: 22 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ minute: 10 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ minute: 35 }, this.restartConnection);\n            _nodeSchedule2.default.scheduleJob({ minute: 55 }, this.restartConnection);\n        }\n    }, {\n        key: 'getInitPrices',\n        value: function getInitPrices() {\n            var _this3 = this;\n\n            try {\n                var timeframe = '5';\n                var symbolsInfo = _symbols.CHART_SYMBOL_GROUPS.reduce(function (result, assetGroup) {\n                    return [].concat((0, _toConsumableArray3.default)(result), (0, _toConsumableArray3.default)(assetGroup.symbols.map(function (symbol) {\n                        return (0, _extends6.default)({}, (0, _getPeriodByTimeframe2.default)(timeframe, assetGroup.id), {\n                            resolution: timeframe,\n                            symbolGroup: assetGroup.id,\n                            symbol: symbol.name\n                        });\n                    })));\n                }, []);\n                var getHistoryFuncs = symbolsInfo.map(function (info) {\n                    return (0, _getHistoryPrice2.default)(info);\n                });\n\n                var _loop = function _loop(i) {\n                    var currentSymbols = symbolsInfo.slice(i * 10, (i + 1) * 10);\n\n                    setTimeout(function () {\n                        Promise.all(currentSymbols.map(function (info) {\n                            return (0, _getHistoryPrice2.default)(info)();\n                        })).then(function (prices) {\n                            prices.forEach(function (data, i) {\n                                if (!data.c) {\n                                    return;\n                                }\n\n                                if ((0, _undefined2.default)(_this3.prices[currentSymbols[i].symbol])) {\n                                    _this3.prices = (0, _extends6.default)({}, _this3.prices, (0, _defineProperty3.default)({}, currentSymbols[i].symbol, (0, _last2.default)(data.c)));\n                                }\n\n                                if ((0, _undefined2.default)(_this3.prevPrices[currentSymbols[i].symbol])) {\n                                    if ((0, _undefined2.default)(_this3.prices[currentSymbols[i].symbol])) {\n                                        _this3.prevPrices = (0, _extends6.default)({}, _this3.prevPrices, (0, _defineProperty3.default)({}, currentSymbols[i].symbol, data.c[data.c.length - 2]));\n                                    } else {\n                                        _this3.prevPrices = (0, _extends6.default)({}, _this3.prevPrices, (0, _defineProperty3.default)({}, currentSymbols[i].symbol, data.c[data.c.length - 1]));\n                                    }\n                                }\n                            });\n                        }).catch(function () {});\n                    }, i * 30000);\n                };\n\n                for (var i = 0; i < Math.ceil(getHistoryFuncs.length / 10); i++) {\n                    _loop(i);\n                }\n            } catch (e) {}\n        }\n    }, {\n        key: 'checkBeforeCloseOrder',\n        value: function () {\n            var _ref6 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n                var _this4 = this;\n\n                var _iteratorNormalCompletion, _didIteratorError, _iteratorError, _loop2, _iterator, _step;\n\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                // console.log('this.orders', this.orders.length);\n                                _iteratorNormalCompletion = true;\n                                _didIteratorError = false;\n                                _iteratorError = undefined;\n                                _context.prev = 3;\n\n                                _loop2 = function _loop2() {\n                                    var order = _step.value;\n\n                                    var assetPrice = _this4.prices[order.assetName];\n                                    // const asset = CHART_SYMBOL_INFO_MAP[order.assetName];\n\n                                    // const openingSlotPrice = getOpeningSlotPrice(asset, assetPrice);\n                                    var orderType = void 0;\n                                    if (order.type === 'buy' && (order.takeProfit && assetPrice >= order.takeProfit && assetPrice > order.openingPrice && (orderType = 'takeProfit') || order.stopLoss && assetPrice <= order.stopLoss && assetPrice < order.openingPrice && (orderType = 'stopLoss'))) {\n                                        // console.log('close buy -> order.id', `old ${order.openingPrice}`, `new assetPrice ${assetPrice}`);\n                                        (0, _lodash2.default)(_this4.orders, function (item) {\n                                            return order.id === item.id;\n                                        });\n                                        _this4.closeOrder(order.id, order.userId, order[orderType]).then(function (data) {\n                                            return pricesEvents.emit(_constants.AUTO_CLOSE_ORDER_EVENT, data);\n                                        }).catch(function (e) {\n                                            return e;\n                                        });\n                                    }\n\n                                    if (order.type === 'sell' && (order.takeProfit && assetPrice <= order.takeProfit && assetPrice < order.openingPrice && (orderType = 'takeProfit') || order.stopLoss && assetPrice >= order.stopLoss && assetPrice > order.openingPrice && (orderType = 'stopLoss'))) {\n                                        // console.log('close sell -> order.id', `old ${order.openingPrice}`, `new $${openingSlotPrice}`);\n                                        (0, _lodash2.default)(_this4.orders, function (item) {\n                                            return order.id === item.id;\n                                        });\n                                        _this4.closeOrder(order.id, order.userId, order[orderType]).then(function (data) {\n                                            return pricesEvents.emit(_constants.AUTO_CLOSE_ORDER_EVENT, data);\n                                        }).catch(function (e) {\n                                            return e;\n                                        });\n                                    }\n                                };\n\n                                for (_iterator = this.orders[Symbol.iterator](); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                                    _loop2();\n                                }\n\n                                _context.next = 12;\n                                break;\n\n                            case 8:\n                                _context.prev = 8;\n                                _context.t0 = _context['catch'](3);\n                                _didIteratorError = true;\n                                _iteratorError = _context.t0;\n\n                            case 12:\n                                _context.prev = 12;\n                                _context.prev = 13;\n\n                                if (!_iteratorNormalCompletion && _iterator.return) {\n                                    _iterator.return();\n                                }\n\n                            case 15:\n                                _context.prev = 15;\n\n                                if (!_didIteratorError) {\n                                    _context.next = 18;\n                                    break;\n                                }\n\n                                throw _iteratorError;\n\n                            case 18:\n                                return _context.finish(15);\n\n                            case 19:\n                                return _context.finish(12);\n\n                            case 20:\n                                _context.next = 22;\n                                return _bluebird2.default.delay(1000);\n\n                            case 22:\n                                _context.next = 24;\n                                return this.checkBeforeCloseOrder();\n\n                            case 24:\n                            case 'end':\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this, [[3, 8, 12, 20], [13,, 15, 19]]);\n            }));\n\n            function checkBeforeCloseOrder() {\n                return _ref6.apply(this, arguments);\n            }\n\n            return checkBeforeCloseOrder;\n        }()\n    }, {\n        key: 'getOredrs',\n        value: function () {\n            var _ref7 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                return _context2.abrupt('return', (0, _base2.default)(_superagent2.default.get(this.prefix + '/api/client/order/all-open').cert(cert).key(key)));\n\n                            case 1:\n                            case 'end':\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function getOredrs() {\n                return _ref7.apply(this, arguments);\n            }\n\n            return getOredrs;\n        }()\n    }, {\n        key: 'closeOrder',\n        value: function closeOrder(id, userId, closedPrice) {\n            return (0, _base2.default)(_superagent2.default.get(this.prefix + '/api/client/order/close-all/' + id + '__' + userId + '__' + closedPrice).cert(cert).key(key));\n        }\n    }]);\n    return PricesController;\n}();\n\nvar pricesController = new PricesController();\n\nexports.default = pricesController;",null]}