{"remainingRequest":"C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\node_modules\\babel-loader\\lib\\index.js??ref--5-2!C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\server\\server.js","dependencies":[{"path":"C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\server\\server.js","mtime":1671546360000},{"path":"C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\.babelrc","mtime":1671546158000},{"path":"C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1671546958000},{"path":"C:\\Users\\cherv\\OneDrive\\Рабочий стол\\deltaway.20\\node_modules\\babel-loader\\lib\\index.js","mtime":1671546956000}],"contextDependencies":[],"result":["'use strict';\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _defineProperty2 = require('babel-runtime/helpers/defineProperty');\n\nvar _defineProperty3 = _interopRequireDefault(_defineProperty2);\n\nvar _jsxFileName = 'C:\\\\Users\\\\cherv\\\\OneDrive\\\\\\u0420\\u0430\\u0431\\u043E\\u0447\\u0438\\u0439 \\u0441\\u0442\\u043E\\u043B\\\\deltaway.20\\\\server\\\\server.js';\n\n// eslint-disable-next-line no-inner-declarations\nvar startMain = function () {\n    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n        var env, pathToScript, port, i;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n            while (1) {\n                switch (_context.prev = _context.next) {\n                    case 0:\n                        console.log('start main');\n\n                        env = process.env.NODE_ENV;\n                        pathToScript = __dirname + '/compiled/server.js';\n                        port = PORT;\n                        i = 0;\n\n                    case 5:\n                        if (!(i < _os2.default.cpus().length - 1)) {\n                            _context.next = 14;\n                            break;\n                        }\n\n                        port += i + 1;\n                        console.log('thread', i + 1, 'port', port);\n                        _context.next = 10;\n                        return new Promise(function (resolve) {\n                            var worker = new _worker_threads.Worker(pathToScript, { workerData: { port: port, env: env } });\n                            worker.on('message', function (data) {\n                                if (data.request === 'init') {\n                                    console.log('init api worker', data.env, data.port);\n\n                                    resolve();\n                                }\n                            });\n                            worker.on('error', function (data) {\n                                return console.log(data);\n                            });\n                            worker.on('exit', function (code) {\n                                return console.log('exit', code);\n                            });\n                        });\n\n                    case 10:\n\n                        port = PORT;\n\n                    case 11:\n                        i++;\n                        _context.next = 5;\n                        break;\n\n                    case 14:\n                    case 'end':\n                        return _context.stop();\n                }\n            }\n        }, _callee, this);\n    }));\n\n    return function startMain() {\n        return _ref.apply(this, arguments);\n    };\n}();\n\nrequire('log-timestamp-moment');\n\nvar _express = require('express');\n\nvar _express2 = _interopRequireDefault(_express);\n\nvar _react = require('react');\n\nvar _react2 = _interopRequireDefault(_react);\n\nvar _os = require('os');\n\nvar _os2 = _interopRequireDefault(_os);\n\nvar _path = require('path');\n\nvar _path2 = _interopRequireDefault(_path);\n\nvar _bodyParser = require('body-parser');\n\nvar _bodyParser2 = _interopRequireDefault(_bodyParser);\n\nvar _cookieParser = require('cookie-parser');\n\nvar _cookieParser2 = _interopRequireDefault(_cookieParser);\n\nvar _mongoose = require('mongoose');\n\nvar _mongoose2 = _interopRequireDefault(_mongoose);\n\nvar _helmet = require('helmet');\n\nvar _helmet2 = _interopRequireDefault(_helmet);\n\nvar _compression = require('compression');\n\nvar _compression2 = _interopRequireDefault(_compression);\n\nvar _expressStaticGzip = require('express-static-gzip');\n\nvar _expressStaticGzip2 = _interopRequireDefault(_expressStaticGzip);\n\nvar _server = require('react-dom/server');\n\nvar _worker_threads = require('worker_threads');\n\nvar _ordersController = require('./controllers/ordersController');\n\nvar _ordersController2 = _interopRequireDefault(_ordersController);\n\nvar _pricesController = require('./controllers/pricesController');\n\nvar _pricesController2 = _interopRequireDefault(_pricesController);\n\nvar _pricesWebsocketController = require('./controllers/pricesWebsocketController');\n\nvar _pricesWebsocketController2 = _interopRequireDefault(_pricesWebsocketController);\n\nvar _messagesWebsocketController = require('./controllers/messagesWebsocketController');\n\nvar _messagesWebsocketController2 = _interopRequireDefault(_messagesWebsocketController);\n\nvar _outputsWebsocketController = require('./controllers/outputsWebsocketController');\n\nvar _outputsWebsocketController2 = _interopRequireDefault(_outputsWebsocketController);\n\nvar _map = require('@tinkoff/utils/array/map');\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _authentication = require('./api/admin/authentication');\n\nvar _authentication2 = _interopRequireDefault(_authentication);\n\nvar _payment = require('./api/admin/payment');\n\nvar _payment2 = _interopRequireDefault(_payment);\n\nvar _article = require('./api/admin/article');\n\nvar _article2 = _interopRequireDefault(_article);\n\nvar _article3 = require('./api/client/article');\n\nvar _article4 = _interopRequireDefault(_article3);\n\nvar _files = require('./api/admin/files');\n\nvar _files2 = _interopRequireDefault(_files);\n\nvar _db = require('./api/admin/db');\n\nvar _db2 = _interopRequireDefault(_db);\n\nvar _user = require('./api/admin/user');\n\nvar _user2 = _interopRequireDefault(_user);\n\nvar _user3 = require('./api/client/user');\n\nvar _user4 = _interopRequireDefault(_user3);\n\nvar _authentication3 = require('./api/client/authentication');\n\nvar _authentication4 = _interopRequireDefault(_authentication3);\n\nvar _qiwi = require('./api/admin/qiwi');\n\nvar _qiwi2 = _interopRequireDefault(_qiwi);\n\nvar _qiwi3 = require('./api/client/qiwi');\n\nvar _qiwi4 = _interopRequireDefault(_qiwi3);\n\nvar _message = require('./api/admin/message');\n\nvar _message2 = _interopRequireDefault(_message);\n\nvar _message3 = require('./api/client/message');\n\nvar _message4 = _interopRequireDefault(_message3);\n\nvar _order = require('./api/client/order');\n\nvar _order2 = _interopRequireDefault(_order);\n\nvar _order3 = require('./api/admin/order');\n\nvar _order4 = _interopRequireDefault(_order3);\n\nvar _data = require('./api/client/data');\n\nvar _data2 = _interopRequireDefault(_data);\n\nvar _transaction = require('./api/client/transaction');\n\nvar _transaction2 = _interopRequireDefault(_transaction);\n\nvar _transaction3 = require('./api/admin/transaction');\n\nvar _transaction4 = _interopRequireDefault(_transaction3);\n\nvar _temp = require('./api/client/temp');\n\nvar _temp2 = _interopRequireDefault(_temp);\n\nvar _payments = require('./api/admin/payments');\n\nvar _payments2 = _interopRequireDefault(_payments);\n\nvar _payments3 = require('./api/client/payments');\n\nvar _payments4 = _interopRequireDefault(_payments3);\n\nvar _moneyOutput = require('./api/admin/moneyOutput');\n\nvar _moneyOutput2 = _interopRequireDefault(_moneyOutput);\n\nvar _moneyOutput3 = require('./api/client/moneyOutput');\n\nvar _moneyOutput4 = _interopRequireDefault(_moneyOutput3);\n\nvar _constants = require('./constants/constants');\n\nvar _constants2 = require('../src/apps/admin/constants/constants');\n\nvar _backups = require('./helpers/backup/backups');\n\nvar _backups2 = _interopRequireDefault(_backups);\n\nvar _actions = require('./actions');\n\nvar _actions2 = _interopRequireDefault(_actions);\n\nvar _getStore = require('../src/apps/client/store/getStore');\n\nvar _getStore2 = _interopRequireDefault(_getStore);\n\nvar _html = require('../src/apps/client/html');\n\nvar _html2 = _interopRequireDefault(_html);\n\nvar _html3 = require('../src/apps/admin/html');\n\nvar _html4 = _interopRequireDefault(_html3);\n\nvar _httpsServer = require('./httpsServer');\n\nvar _reactRedux = require('react-redux');\n\nvar _reactRouterDom = require('react-router-dom');\n\nvar _reactHelmet = require('react-helmet');\n\nvar _reactHelmet2 = _interopRequireDefault(_reactHelmet);\n\nvar _App = require('../src/apps/client/App.jsx');\n\nvar _App2 = _interopRequireDefault(_App);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar rootPath = _path2.default.resolve(__dirname, '..');\nvar PORT = process.env.NODE_ENV === 'production' ? +(process.env.PORT || 3000) + 1 : process.env.PORT || 3000;\n\nfunction createApp() {\n    return new Promise(function (resolve) {\n        var app = (0, _express2.default)();\n\n        app.use((0, _helmet2.default)());\n\n        // mongodb\n        _mongoose2.default.connect(_constants.DATABASE_URL, { useNewUrlParser: true, useFindAndModify: false, useCreateIndex: true });\n        (0, _backups2.default)();\n\n        (0, _httpsServer.httpsRedirect)(app);\n\n        // static\n        app.get(/\\.chunk\\.(js|css)$/, (0, _expressStaticGzip2.default)(rootPath, {\n            enableBrotli: true,\n            orderPreference: ['br']\n        }));\n        app.use((0, _compression2.default)());\n        app.use(function (req, res, next) {\n            var isCodeFiles = req.url.match(/(.js|.jsx|.json|.css|.key|.pem)$/i);\n\n            if (isCodeFiles) {\n                return handleApp(req, res);\n            }\n            next();\n        });\n        app.use(_express2.default.static(rootPath));\n\n        // helpers\n        app.use(_bodyParser2.default.urlencoded({ limit: '25mb', extended: true }));\n        app.use(_bodyParser2.default.json({ limit: '25mb', extended: true }));\n        app.use((0, _cookieParser2.default)());\n\n        // api\n        app.use('/api/admin/authentication', _authentication2.default);\n        app.use('/api/admin/payment', _payment2.default);\n        app.use('/api/admin/article', _article2.default);\n        app.use('/api/admin/files', _files2.default);\n        app.use('/api/client/article', _article4.default);\n        app.use('/api/admin/db', _db2.default);\n        app.use('/api/admin/user', _user2.default);\n        app.use('/api/client/user', _user4.default);\n        app.use('/api/client/authentication', _authentication4.default);\n        app.use('/api/admin/qiwi', _qiwi2.default);\n        app.use('/api/client/qiwi', _qiwi4.default);\n        app.use('/api/admin/message', _message2.default);\n        app.use('/api/client/message', _message4.default);\n        app.use('/api/client/order', _order2.default);\n        app.use('/api/admin/order', _order4.default);\n        app.use('/api/client/transaction', _transaction2.default);\n        app.use('/api/admin/transaction', _transaction4.default);\n        app.use('/api/client/data', _data2.default);\n        app.use('/api/client/temp', _temp2.default);\n        app.use('/api/admin/payments', _payments2.default);\n        app.use('/api/client/payments', _payments4.default);\n        app.use('/api/admin/output', _moneyOutput2.default);\n        app.use('/api/client/output', _moneyOutput4.default);\n\n        // admin\n        var adminUrlRegex = new RegExp('^' + _constants2.ADMIN_PANEL_URL);\n        app.get(adminUrlRegex, function (req, res) {\n            var page = (0, _html4.default)();\n\n            res.send(page);\n        });\n\n        // app\n        app.get('*', handleApp);\n\n        function handleApp(req, res) {\n            var _this = this;\n\n            var store = (0, _getStore2.default)();\n            Promise.all((0, _map2.default)(function (actionFunc) {\n                return actionFunc(req, res)(store.dispatch);\n            }, _actions2.default)).then(function () {\n                var _React$createElement, _React$createElement2, _React$createElement3;\n\n                var context = {};\n                var html = (0, _server.renderToString)(_react2.default.createElement(\n                    _reactRedux.Provider,\n                    (_React$createElement3 = { store: store, 'data-qa-file': 'server',\n                        __source: {\n                            fileName: _jsxFileName,\n                            lineNumber: 145\n                        },\n                        __self: _this\n                    }, (0, _defineProperty3.default)(_React$createElement3, '__self', _this), (0, _defineProperty3.default)(_React$createElement3, 'data-qa-file', 'server'), (0, _defineProperty3.default)(_React$createElement3, 'data-qa-file', 'server'), _React$createElement3),\n                    _react2.default.createElement(\n                        _reactRouterDom.StaticRouter,\n                        (_React$createElement2 = {\n                            location: req.originalUrl,\n                            context: context,\n                            'data-qa-file': 'server',\n                            __source: {\n                                fileName: _jsxFileName,\n                                lineNumber: 146\n                            },\n                            __self: _this\n                        }, (0, _defineProperty3.default)(_React$createElement2, '__self', _this), (0, _defineProperty3.default)(_React$createElement2, 'data-qa-file', 'server'), (0, _defineProperty3.default)(_React$createElement2, 'data-qa-file', 'server'), _React$createElement2),\n                        _react2.default.createElement(_App2.default, (_React$createElement = {\n                            'data-qa-file': 'server',\n                            __source: {\n                                fileName: _jsxFileName,\n                                lineNumber: 150\n                            },\n                            __self: _this\n                        }, (0, _defineProperty3.default)(_React$createElement, '__self', _this), (0, _defineProperty3.default)(_React$createElement, 'data-qa-file', 'server'), (0, _defineProperty3.default)(_React$createElement, 'data-qa-file', 'server'), _React$createElement))\n                    )\n                ));\n                var helmet = _reactHelmet2.default.renderStatic();\n                var preloadedState = store.getState();\n                var page = (0, _html2.default)(html, helmet, preloadedState);\n\n                res.send(page);\n            });\n        }\n\n        app.listen(_worker_threads.isMainThread ? PORT : _worker_threads.workerData.port, function () {\n            console.log('listening on port', _worker_threads.isMainThread ? PORT : _worker_threads.workerData.port); // eslint-disable-line no-console\n\n            if (_worker_threads.isMainThread) {\n                _pricesController2.default.start();\n                _ordersController2.default.start();\n                _pricesWebsocketController2.default.start();\n                _messagesWebsocketController2.default.start();\n                _outputsWebsocketController2.default.start();\n            }\n\n            resolve();\n        });\n\n        // TODO: добавьте сертификаты https в код и верните эту строку\n        _worker_threads.isMainThread ? (0, _httpsServer.startHttpsServer)(app) : '';\n    });\n}\n\nif (_worker_threads.isMainThread) {\n    process.env.NODE_ENV === 'production' ? startMain() : '';\n    // startMain();\n    createApp();\n} else {\n    createApp().then(function () {\n        return _worker_threads.parentPort.postMessage({ request: 'init', env: process.env.NODE_ENV });\n    });\n}",null]}