{"remainingRequest":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/babel-loader/lib/index.js??ref--5-2!/Users/dimasabitov/Downloads/deltaway.20/server/api/admin/order/services/closeOrder.js","dependencies":[{"path":"/Users/dimasabitov/Downloads/deltaway.20/server/api/admin/order/services/closeOrder.js","mtime":1671546373709},{"path":"/Users/dimasabitov/Downloads/deltaway.20/.babelrc","mtime":1671546158632},{"path":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/cache-loader/dist/cjs.js","mtime":1671546959174},{"path":"/Users/dimasabitov/Downloads/deltaway.20/node_modules/babel-loader/lib/index.js","mtime":1671546957682}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.default = closeOrder;\n\nvar _constants = require('../../../../constants/constants');\n\nvar _editUser = require('../../../client/user/queries/editUser');\n\nvar _editUser2 = _interopRequireDefault(_editUser);\n\nvar _editOrder = require('../../../client/order/queries/editOrder');\n\nvar _editOrder2 = _interopRequireDefault(_editOrder);\n\nvar _getUserById = require('../../../client/user/queries/getUserById');\n\nvar _getUserById2 = _interopRequireDefault(_getUserById);\n\nvar _getAssetValues = require('../../../../../src/apps/client/utils/getAssetValues');\n\nvar _getOrderById = require('../../../client/order/queries/getOrderById');\n\nvar _getOrderById2 = _interopRequireDefault(_getOrderById);\n\nvar _constants2 = require('../../../../../src/apps/client/constants/constants');\n\nvar _symbols = require('../../../../constants/symbols');\n\nvar _numeral = require('numeral');\n\nvar _numeral2 = _interopRequireDefault(_numeral);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction closeOrder(req, res) {\n    try {\n        var orderInfo = req.body;\n        (0, _getOrderById2.default)(orderInfo.id).then(function (order) {\n            (0, _getUserById2.default)(order.userId).then(function (user) {\n                if (!order || order.userId !== user.id) {\n                    return res.status(_constants.BAD_REQUEST_STATUS_CODE).send();\n                }\n\n                var closedOrder = {\n                    id: order.id,\n                    isClosed: orderInfo.isClosed,\n                    closedAt: orderInfo.closedAt,\n                    closedPrice: (0, _numeral2.default)(orderInfo.closedPrice).value()\n                };\n\n                var asset = _symbols.CHART_SYMBOL_INFO_MAP[order.assetName];\n                var profit = (0, _getAssetValues.getProfit)(order.amount, order.openingPrice, closedOrder.closedPrice, order.type, asset);\n                var commission = (0, _getAssetValues.getCommission)(order.pledge, _constants2.COMMISSION);\n                var updatedUser = {\n                    id: orderInfo.userId,\n                    balance: user.balance + profit - commission\n                };\n\n                Promise.all([(0, _editOrder2.default)(closedOrder), (0, _editUser2.default)(updatedUser)]).then(function () {\n                    res.status(_constants.OKEY_STATUS_CODE).end();\n                });\n            }).catch(function () {\n                res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n            });\n        }).catch(function () {\n            res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n        });\n    } catch (e) {\n        res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n    }\n}\ncloseOrder.i = 'closeOrder';\ncloseOrder.i = 'closeOrder';",null]}