{"remainingRequest":"/home/vps/ppf/node_modules/babel-loader/lib/index.js??ref--5-2!/home/vps/ppf/server/api/admin/transaction/services/saveTransaction.js","dependencies":[{"path":"/home/vps/ppf/server/api/admin/transaction/services/saveTransaction.js","mtime":1671127475489},{"path":"/home/vps/ppf/.babelrc","mtime":1671127885972},{"path":"/home/vps/ppf/node_modules/cache-loader/dist/cjs.js","mtime":1671127657171},{"path":"/home/vps/ppf/node_modules/babel-loader/lib/index.js","mtime":1671127654997}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\n\nvar _extends2 = require('babel-runtime/helpers/extends');\n\nvar _extends3 = _interopRequireDefault(_extends2);\n\nexports.default = saveTransaction;\n\nvar _uniqid = require('uniqid');\n\nvar _uniqid2 = _interopRequireDefault(_uniqid);\n\nvar _constants = require('../../../../constants/constants');\n\nvar _prepareTransaction = require('../utils/prepareTransaction');\n\nvar _prepareTransaction2 = _interopRequireDefault(_prepareTransaction);\n\nvar _saveTransaction = require('../../../client/transaction/queries/saveTransaction');\n\nvar _saveTransaction2 = _interopRequireDefault(_saveTransaction);\n\nvar _getUserById = require('../../../client/user/queries/getUserById');\n\nvar _getUserById2 = _interopRequireDefault(_getUserById);\n\nvar _editUser = require('../../../client/user/queries/editUser');\n\nvar _editUser2 = _interopRequireDefault(_editUser);\n\nvar _getAllUsers = require('../../../client/user/queries/getAllUsers');\n\nvar _getAllUsers2 = _interopRequireDefault(_getAllUsers);\n\nvar _getStatus = require('../../../../helpers/getStatus');\n\nvar _getStatus2 = _interopRequireDefault(_getStatus);\n\nvar _checkBalance = require('../utils/checkBalance');\n\nvar _checkBalance2 = _interopRequireDefault(_checkBalance);\n\nvar _getAllTransactions = require('../../../client/transaction/queries/getAllTransactions');\n\nvar _getAllTransactions2 = _interopRequireDefault(_getAllTransactions);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction saveTransaction(req, res) {\n    var transaction = (0, _prepareTransaction2.default)(req.body);\n    var id = (0, _uniqid2.default)();\n\n    (0, _saveTransaction2.default)((0, _extends3.default)({}, transaction, { id: id, createdAt: Date.now() })).then(function (transaction) {\n        (0, _getUserById2.default)(transaction.userId).then(function (user) {\n            var balance = user.balance;\n            var bonuses = user.bonuses || 0;\n            var credFacilities = user.credFacilities || 0;\n            var mainBalance = user.mainBalance || 0;\n\n            var info = { id: user.id };\n            if (transaction.type === 'deposit') {\n                info.balance = (0, _checkBalance2.default)(balance + transaction.value);\n                info.mainBalance = (0, _checkBalance2.default)(mainBalance + transaction.value);\n            }\n            if (transaction.type === 'bonuses') {\n                info.bonuses = (0, _checkBalance2.default)(bonuses + transaction.value);\n            }\n            if (transaction.type === 'credFacilities') {\n                info.credFacilities = (0, _checkBalance2.default)(credFacilities + transaction.value);\n            }\n\n            info.accountStatus = (0, _getStatus2.default)((0, _checkBalance2.default)(user.balance, user.isVipStatus));\n\n            (0, _editUser2.default)(info).then(function () {\n                (0, _getAllUsers2.default)().then(function (users) {\n                    (0, _getAllTransactions2.default)().then(function (transactions) {\n                        res.status(_constants.OKEY_STATUS_CODE).send({ users: users, transactions: transactions });\n                    });\n                }).catch(function () {\n                    res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n                });\n            }).catch(function () {\n                res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n            });\n        });\n    }).catch(function () {\n        res.status(_constants.SERVER_ERROR_STATUS_CODE).end();\n    });\n}\nsaveTransaction.i = 'saveTransaction';\nsaveTransaction.i = 'saveTransaction';",null]}